---
title: "Finding Fallow Fields"
author: "Iris Foxfoot"
date: "4/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(sf)
library(tidyverse)
library(janitor)
```

# Read in and Process Kern Field Data

```{r}
#set up project crs
proj_crs = crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")
```

```{r}
#read in kernfields

#create list of years
kern_field_years <- c(2005:2020)

#loop through read-in process
for (i in kern_field_years) {
  filename <- paste0("kernfields_", i)
  wd <- paste0("data/kernfields/kern", i, ".shp")
  assign(filename, read_sf(wd))
}

#loop through listed sf objects and tidy
fields_cleaned_list <- lapply(mget(sprintf("kernfields_%d", 2005:2020)), 
                 function(x) 
                   {
                   
                   clean_names(x) %>%
                     st_make_valid() %>% 
                     st_transform(crs = proj_crs) %>%
                     dplyr::select(permit,
                                   pmt_site,
                                   township,
                                   range,
                                   s_status,
                                   p_status,
                                   dt_act)
                   
                     }
                 )


#rbind inputs
all_fields_binded <- do.call(rbind, fields_cleaned_list) %>% 
  st_make_valid() %>% 
  mutate(year = lubridate::year(dt_act))
```

# Read in and Process Historical Landuse Data

Historical landuse data for years 1885, 1912, 1945, 1977, and 2004. Link to databasin page:https://databasin.org/galleries/7a6eb74f387047b4a22d563be0bc494f/   

```{r}
#read in kern county shapefile for clipping
kern_county <- read_sf("data/Kern_County_Boundary/Kern_County_Boundary.shp") %>% 
  st_transform(crs = proj_crs)

#read in sjv historical landuse data
sjv_historical_landuse <- read_sf("data/esrp_histlu/histlu200408.shp") %>% 
  st_transform(crs = proj_crs)

#clip historical landuse data to kern county
historical_landuse_kern <- st_crop(sjv_historical_landuse, kern_county)

#select only values that were irrigated at some point
hist_irrigated <- historical_landuse_kern %>% 
  filter_all(any_vars(. %in% c("Irrigated")))
```

# Read in and Process FAM Data

FAM data has been reprojected, clipped to kern county, and polygonized in QGIS.

```{r}
#loop through read-in process
for (i in kern_field_years) {
  filename_FAM <- paste0("FAM_", i)
  wd_FAM <- paste0("data/FAM_TIF/FAM_processed/FAM_clipped_", i, ".gpkg")
  assign(filename_FAM, read_sf(wd_FAM))
}

#loop through listed sf objects and tidy
FAM_cleaned_list <- lapply(mget(sprintf("FAM_%d", 2011:2017)), 
                 function(x) 
                   {
                   
                   clean_names(x) %>%
                     st_make_valid() %>% 
                     st_transform(crs = proj_crs) %>% 
                     mutate(year = year)
                   
                     }
                 )

#bind FAM data together, include new column saying what year it came from
FAM_binded <- do.call(rbind, lapply(names(FAM_cleaned_list), 
                                    function(x) 
                                      cbind(FAM_cleaned_list[[x]], 
                                            source = x)
                                    ))

```

# Decide when FAM can be considered fallowed

FAM data can be considered fallowed when 
* 1. It is not associated with a permit_site_ID from the kernfield data for the same year
* 2. Historical data shows that it was previously irrigated land

```{r}
#2011 example

#select FAM fields that are fallowed, add row number
fallowed_FAM <- FAM_binded %>% 
  filter(fallowed == 3)

#select FAM fallowed that were irrigated
fallowed_irrigated_FAM <- st_filter(fallowed_FAM, hist_irrigated, .predicate = st_intersects)

#select pmts from 2011
pmt_2011 <- all_fields_binded %>% 
  filter(year <= 2011)

#select FAM that does not have permit_site_id for 2011
true_fallowed_FAM <- fallowed_irrigated_FAM[!lengths(st_intersects(fallowed_irrigated_FAM, pmt_2011)), ]

#write to shapefile
st_write(true_fallowed_FAM, "data/shapefiles_written/2011_true_fam.shp", append = F)
```

