---
title: "conservation areas exploration"
author: "Iris Foxfoot"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(here)
library(tidyverse)
library(janitor)
library(tmap)
```

This is an exploration of the California Conservation Easement Database (CCED) and California Protected Area Database (CPAD). The goal is to find conservation areas that have never been farmed, which are similar enough to compare to agricultural areas

```{r, read in data}
#read in cced database
easements <- read_sf(here("data", "CCED_2021b", "CCED_2021b_Release.shp"))

#read in cpad database
protected_areas_holdings <- read_sf(here("data", "CPAD_2021b", "CPAD_2021b_Holdings.shp"))
protected_areas_superunits <- read_sf(here("data", "CPAD_2021b", "CPAD_2021b_SuperUnits.shp"))
protected_areas_units <- read_sf(here("data", "CPAD_2021b", "CPAD_2021b_Units.shp"))

#getting crs for protected ares
proj_crs <- st_crs(easements)

#read in aggregated agriculture file (years 2016-2019), transform to same crs as other files
farms <- read_sf(here("data", "shapefiles_written", "unioned_fields_20162019", "unioned_fields_20162019.shp")) %>% 
  st_transform(crs = proj_crs)

#check units on farms
st_crs(farms)$units
```

```{r}
#buffer farms to 100m
farms_buffered <- st_buffer(farms, dist = 100)

#view it
plot(st_geometry(farms_buffered))
```

```{r}
#get protected areas within 100m of farms
easements_near_farms <- st_intersection(easements, farms_buffered)
holdings_near_farms <- st_intersection(protected_areas_holdings, farms_buffered)
superunits_near_farms <- st_intersection(protected_areas_superunits, farms_buffered)
units_near_farms <- st_intersection(protected_areas_units, farms_buffered)

#get gap status 1, 2, 3, or pre 1950s conservation areas
#also make col names consistent
long_easements <- easements_near_farms %>% 
  filter(gapcat <= 3 | year_est %in% c(1:1950)) %>% 
  clean_names() %>% 
  mutate("unit_id" = e_hold_id,
         "unit_name" =  sitename,
         "agncy_name" = esmthldr,
         "yr_est" =  year_est) %>% 
  select(unit_id, unit_name, agncy_name, yr_est, gap1_acres, gap2_acres, gap3_acres, gap4_acres)

long_holdings <- holdings_near_farms %>% 
  filter(GAP1_acres > 0 | GAP2_acres > 0 | GAP3_acres > 0 | YR_EST %in% c(1:1950)) %>% 
  clean_names() %>% 
  select(unit_id, unit_name, agncy_name, yr_est, gap1_acres, gap2_acres, gap3_acres, gap4_acres)

long_superunits <- superunits_near_farms %>% 
  filter(GAP1_acres > 0 | GAP2_acres > 0 | GAP3_acres > 0 | YR_EST %in% c(1:1950)) %>% 
  clean_names() %>% 
  mutate("unit_id" = suid_nma,
         "unit_name" =  park_name,
         "agncy_name" = mng_agency) %>% 
  select(unit_id, unit_name, agncy_name, yr_est, gap1_acres, gap2_acres, gap3_acres, gap4_acres)
  
long_units <- units_near_farms %>% 
  filter(GAP1_acres > 0 | GAP2_acres > 0 | GAP3_acres > 0 | YR_EST %in% c(1:1950))  %>% 
  clean_names() %>% 
  select(unit_id, unit_name, agncy_name, yr_est, gap1_acres, gap2_acres, gap3_acres, gap4_acres)

#bind together
conservation_areas <- rbind(long_easements, long_holdings, long_superunits, long_units)
```

```{r}
#map it
tmap_mode("view")

tm_shape(conservation_areas) +
  tm_polygons("unit_name", legend.show = FALSE)
```

```{r}
#explore soil quality in the conservation area

```

