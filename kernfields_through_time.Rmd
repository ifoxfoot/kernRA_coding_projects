---
title: "Kern County Fields Through Time"
author: "Iris Foxfoot"
date: "1/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r get_packages}
knitr::opts_chunk$set(echo = TRUE)
library(sf) #for polygons
library(tidyverse) #for data wrangling
library(janitor) #for converting names to lowercase snake
library(tmap) #for interactive maps
library(reshape2) #for melting and recasting data frames (long to wide format)
```

# Introduction

# Read in field data and wrangle it

In this section read in the field data and wrangle it such that the end product is a single SF object where each row is a field and the columns are for geometry and for permitsite ID, crop code, and year, which are merged to single string.

```{r field_data_wrangling}
#read in kern data
#must have the following file path in working directory: data/kernfields/kernYEAR.shp

#create list of years
kern_field_years <- c(1997:2021)

#loop through read-in process
for (i in kern_field_years) {
  filename <- paste0("kernfields_", i)
  wd <- paste0("data/kernfields/kern", i, ".shp")
  assign(filename, read_sf(wd))
}

kernfields_2021 <- kernfields_2021 %>% 
  mutate(comm = Commodity)

#loop through listed sf objects and tidy
fields_cleaned_list <- lapply(mget(sprintf("kernfields_%d", 1997:2021)), 
                 function(x) 
                   {
                   clean_names(x) %>%
                     st_make_valid() %>% 
                     st_transform(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs") %>%
                     #select pmt_site and comm (not all years have comm code)
                     dplyr::select(pmt_site, comm)
                     }
                 )


#bind crop data together, include new column "source" saying what dataset it came from (year)
kernfield_bind <- do.call(rbind, lapply(names(fields_cleaned_list), 
                                    function(x) 
                                      cbind(fields_cleaned_list[[x]], 
                                            source = x)
                                    )) %>% 
    #turn source column into year column by keeping only numbers
    mutate(year = gsub("\\D", "", source)) %>% 
    #Create ID column
    mutate(id = row_number()) %>% 
    #merge comm code to pmt_site
    mutate(pmt_site_code = str_c(pmt_site, "-", comm)) %>% 
    #merge ID to  pmt_site
    mutate(pmt_site_id = str_c(pmt_site_code, "-", id)) %>% 
    #merge this column with year
    mutate(pmt_site_string = str_c(year, "_", pmt_site_id))

#select only column we need, clean geometry
kernfield_clean <- kernfield_bind %>% 
  dplyr::select(pmt_site_string) %>% 
  st_buffer(dist = 0) %>% #for some reason it only works with a zero buffer
  st_make_valid()


#write to shapefile
#st_write(kernfield_clean, "data/shapefiles_written/1997-2021kernfields.shp", driver = "ESRI Shapefile")
```

Take the resulting shapefile `sample_clean.shp` and upload it to mapshaper's online interface (https://mapshaper.org/). Select the box saying "detect line intersections" and the box "snap vertices". Then enter in the console `$ mosaic`. The processing can take 30-45 minutes. Download results as a shapefile by clicking export and selecting shapefile. It will download in a zipfile.

This thread could potentially improve workflow https://github.com/mbloch/mapshaper/issues/353 

# Using Mapshaper outputs to create pivot table (where col name is from year and rows are smallest intersection of fields)

```{r}
#read in data from mapshaper outputs
mosaic <- read_sf("data/mapshaper_outputs/1997-2021kernfields/1997-2021kernfields.shp") 

#drop polys under one acre and clean
mosaic_drop_acre <- mosaic %>%
  mutate(area = st_area(.)) %>% 
  filter(area >= units::set_units(43560,"ft^2")) %>% 
  st_transform(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs") %>% 
  st_make_valid()

#negative buffer and intersect with field data
kernfield_join <- st_intersection(st_buffer(mosaic_drop_acre, dist = -1), kernfield_clean)

#pivot so each column is a year
kernfield_pivot <- kernfield_join %>%
  filter(!is.na(pmt_site_string)) %>% 
  separate(pmt_site_string, into = c("year", "pmt_site"), sep = "_") %>% 
  select(-c(FID, area)) %>% 
  pivot_wider(names_from = year, values_from = pmt_site) %>%
  st_sf() %>% 
  st_buffer(dist = 1)

#making a df without pmt_sites for export to explore
kernfield_pivot_over_acre <- kernfield_pivot %>%
  mutate(area = st_area(.)) %>% 
  filter(area >= units::set_units(1,"acre"))

#write to csv
write_csv(kernfield_pivot_over_acre, "data/shapefiles_written/1997-2021_pivoted.csv")

#write to shapefile
st_write(kernfield_pivot_test_shp, "data/shapefiles_written/1997-2021_pivoted.shp", driver = "ESRI Shapefile")
```


```{r}

```

