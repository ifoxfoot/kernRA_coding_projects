---
title: "Kern County Fields Through Time"
author: "Iris Foxfoot"
date: "1/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
library(here)
library(raster)
library(tmap)
library(janitor)
```

```{r}
#read in data
#must have the following file path in working directory: data/kernfields/kernYEAR/kernYEAR.shp

#create list of years
kern_field_layers <- c(2016:2019)

#loop through read in process
for (i in kern_field_layers) {
  filename <- paste0("kernfields_", i)
  wd <- paste0("data/kernfields/kern", i, "/kern", i, ".shp")
  assign(filename, read_sf(wd))
}

#read in kern county shapefile
kern_county <- read_sf(here("data", "Kern_County_Boundary", "Kern_County_Boundary.shp")) %>% 
  st_transform(crs = crs(kernfields_2016))
```

```{r}
#clean names, make sure each polygon has same number of rows

kern_16_clean <- kernfields_2016 %>% 
  clean_names() %>% 
  mutate(symbol = NA) %>% 
  mutate(comm_code = NA) %>% 
  mutate(year = 2016)

kern_17_clean <- kernfields_2017 %>% 
  clean_names() %>% 
  mutate(year = 2017)

kern_18_clean <- kernfields_2018 %>% 
  clean_names() %>% 
  mutate(year = 2018)

kern_19_clean <- kernfields_2019 %>% 
  clean_names()  %>% 
  mutate(year = 2019)


#bind all rows,dissolve (union) boundaries
kern_binded <- rbind(kern_16_clean, kern_17_clean, kern_18_clean, kern_19_clean) %>% 
  st_union()

#plot
plot(st_geometry(kern_binded))

#write to sf
#st_write(kern_binded, here("data", "shapefiles_written", "unioned_fields_20162019"), driver = "ESRI Shapefile")

```

```{r}
#crop

#select region (based off of farmer)
kern_subset <- kern_19_clean %>% 
  filter(agent == "McMANUS/WILSON,MICHELE/AARIN")

plot(kern_subset["p_status"])

#crop
kern_19_crop <- st_crop(kern_19_clean, kern_subset)

plot(kern_19_crop["p_status"])

kern_18_crop <- st_crop(kern_18_clean, kern_subset)

kern_county_crop <- st_crop(kern_county, kern_subset)

plot(kern_county_crop["FID"])
```

```{r}
# Convert to tibble for a dplyr full join on the geometry column.
kern1819_intersect <- full_join(as_tibble(kern_18_crop), as_tibble(kern_19_crop), by = "geometry")

kern_1819_sf <- st_as_sf(kern_18_intersection)
```

```{r}
#DOES NOT WORK, IS DROPPING NON INTERSECTING POLYGONS

plot(kern_19_crop["p_status"], main = "2019")
plot(kern_18_crop["p_status"], main = "2018")
plot(kern_1819_sf ["p_status.x"], main = "Intersect")
```

```{r}
library(stampr)
library(sp)

croped_fields_binded <- rbind(kern_18_crop, kern_19_crop) %>% 
  st_make_valid() %>% 
  rownames_to_column(var="ID")


cropped_sp <- as(croped_fields_binded, "Spatial")

stamp_test <- stamp.multichange(cropped_sp, changeByField = T, changeField = "year", dc = 0, distance = TRUE, direction = F)

stamp_test_sf <- st_as_sf(stamp_test)

plot(stamp_test_sf["GROUP"])

st_write(stamp_test_sf, here("data", "shapefiles_written", "stamp_test.shp"), driver = "ESRI Shapefile")
```
