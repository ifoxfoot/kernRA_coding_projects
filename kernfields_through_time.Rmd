---
title: "Kern County Fields Through Time"
author: "Iris Foxfoot"
date: "1/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r get_packages}
knitr::opts_chunk$set(echo = TRUE)
library(sf) #for polygons
library(tidyverse) #for data wrangling
library(here) #for file paths
library(raster) #for rasters
library(fasterize) #for making rasters
library(tmap) #for interactive maps
library(janitor) #for cleaning names
library(stampr) #for space time analysis
library(sp) #spatial polygons, required for stampr to work
library(smoothr) #drops slivers
library(nngeo) #for removing geometry holes
```

# Introduction

# Read in field data and wrangle it

In this section read in the field data and wrangle it such that the end product is a single SF object where each row is a field and the columns are for geometry and for permitsite ID and year, which are merged to single string.

```{r field_data_wrangling}
#read in kern data
#must have the following file path in working directory: data/kernfields/kernYEAR.shp

#create list of years
kern_field_years <- c(2005:2020)

#loop through read-in process
for (i in kern_field_years) {
  filename <- paste0("kernfields_", i)
  wd <- paste0("data/kernfields/kern", i, ".shp")
  assign(filename, read_sf(wd))
}

#loop through listed sf objects and tidy
fields_cleaned_list <- lapply(mget(sprintf("kernfields_%d", 2005:2020)), 
                 function(x) 
                   {
                   
                   clean_names(x) %>%
                     st_make_valid() %>% 
                     st_transform(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs") %>%
                     #mutate(township = "T", range = "R") %>% 
                     dplyr::select(permit,
                                   pmt_site,
                                   township,
                                   range,
                                   s_status,
                                   p_status,
                                   dt_act)
                   
                     }
                 )


#rbind inputs
all_fields_binded <- do.call(rbind, fields_cleaned_list) %>% 
  st_make_valid()

#make id column, get year
all_fields <- all_fields_binded%>% 
  st_make_valid() %>% 
  rownames_to_column(var="ID") %>% 
  mutate(year = lubridate::year(dt_act)) %>% 
  dplyr::select(-dt_act) %>% 
  mutate(township_range = str_c(township, "_", range)) %>% 
  mutate(pmt_site_year = str_c(year, "_", pmt_site))

#select just pmt_site_year
all_fields_single_col <- all_fields %>% 
  dplyr::select(pmt_site_year) %>% 
  st_make_valid() %>% 
  st_buffer(dist = 0)


#write to shapefile
#st_write(all_fields_single_col, "data/shapefiles_written/2005-2020kernfields.shp")


#NOTES
#need to add in 2021 (which has different col names)
#need crops in final product?
#when uploaded to mapshaper, click one or both boxes?
```

Take the resulting shapefile `sample_clean.shp` and upload it to mapshaper's online interface (https://mapshaper.org/). Then enter in the command line `$ mosaic` and download results as a shapefile, as seen in the next code chunk.

This thread could potentially improve workflow https://github.com/mbloch/mapshaper/issues/353 

# Using Mapshaper outputs

```{r}
#read in data from mapshaper outputs
mosiac <- st_read("data/mapshaper_outputs/2005-2020kernfields/2005-2020kernfields.shp") %>% 
  st_make_valid() %>% 
  st_transform(crs = st_crs(all_fields_single_col))

#negative buffer and intersect with field data
sample_join <- st_intersection(st_buffer(mosiac, dist = -1), all_fields_single_col)

#pivot so each column is a year
sample_pivot <- sample_join %>% 
  separate(pmt_site_year, into = c("year", "pmt_site"), sep = "_") %>% 
  select(-FID) %>% 
  pivot_wider(names_from = year, values_from = pmt_site) %>%
  st_sf() %>% 
  st_buffer(dist = 0) %>% 
  st_make_valid()

#write to csv
write_csv(sample_pivot, "data/shapefiles_written/2005-2020_pivoted.csv")
```
